# Contract: HomeAtlas Public API

## Module Overview
- **Module Name**: `HomeAtlas`
- **Purpose**: Provide strongly typed wrappers around Apple HomeKit accessories, services, and characteristics with `@MainActor` enforcement and async/await APIs.
- **Current Version**: 0.1.0
- **Implementation Status**: US1 complete, US2 complete, US3 pending

## Core Types (US1 - ✅ Implemented)

### `Characteristic<Value>`
Open generic class wrapping `HMCharacteristic` with type-safe operations.

```swift
@MainActor
open class Characteristic<Value> {
    public var characteristicType: String { get }
    public var localizedDescription: String { get }
    public var supportsRead: Bool { get }
    public var supportsWrite: Bool { get }
    public var supportsEventNotification: Bool { get }

    public func read() async throws -> Value
    public func write(_ value: Value) async throws
    public func setNotifications(enabled: Bool) async throws
}
```

**Design**: Open class allows autogenerated characteristic subclasses to add service-specific behavior.

### `Service`
Open base class for service wrappers.

```swift
@MainActor
open class Service {
    public var serviceType: String { get }
    public var name: String? { get }
    public var isPrimaryService: Bool { get }
    public var uniqueIdentifier: UUID { get }

    public func characteristic<Value>(ofType: String) -> Characteristic<Value>?
    public func allCharacteristics() -> [Characteristic<Any>]
}
```

**Design**: Open class allows autogenerated services (e.g., `LightbulbService`) to subclass and add typed characteristic properties.

### `Accessory`
Final wrapper for `HMAccessory`.

```swift
@MainActor
public final class Accessory {
    public var name: String { get }
    public var uniqueIdentifier: UUID { get }
    public var isReachable: Bool { get }
    public var isBlocked: Bool { get }

    public func service(ofType: String) -> Service?
    public func allServices() -> [Service]
    public func identify() async throws
    public func updateName(_ name: String) async throws
}
```

### `HomeKitManager`
MainActor-bound manager for home and accessory discovery.

```swift
@MainActor
public final class HomeKitManager: ObservableObject {
    @Published public private(set) var homes: [HMHome] { get }
    @Published public private(set) var isReady: Bool { get }

    public func waitUntilReady() async
    public var primaryHome: HMHome? { get }
    public func allAccessories() -> [Accessory]
    public func accessory(named: String) -> Accessory?
    public func home(named: String) -> HMHome?
}
```

### Type Constants

```swift
public enum ServiceType {
    public static let lightbulb: String
    public static let thermostat: String
    public static let switch: String
    // ... more service types
}

public enum CharacteristicType {
    public static let powerState: String
    public static let brightness: String
    public static let currentTemperature: String
    // ... more characteristic types
}
```

## Error Types & Diagnostics (US2 - ✅ Implemented)

### `HomeKitError`
```swift
public enum HomeKitError: Error {
    case characteristicValueUnavailable(context: CharacteristicContext)
    case characteristicTypeMismatch(expected: String, actual: String, context: CharacteristicContext)
    case characteristicTransport(operation: HomeKitOperation, context: CharacteristicContext, underlying: Error)
    case accessoryOperationFailed(operation: HomeKitOperation, context: AccessoryContext, underlying: Error)
    case platformUnavailable(reason: String)
}
```

### Context Types
```swift
public struct CharacteristicContext {
    public let accessoryIdentifier: UUID?
    public let accessoryName: String?
    public let serviceIdentifier: UUID?
    public let serviceType: String?
    public let serviceName: String?
    public let characteristicIdentifier: UUID?
    public let characteristicType: String
    public let characteristicName: String?
}

public struct AccessoryContext {
    public let accessoryIdentifier: UUID?
    public let accessoryName: String?
    public let roomName: String?
    public let category: String?
}

public enum HomeKitOperation: String {
    case characteristicRead
    case characteristicWrite
    case characteristicNotification
    case accessoryIdentify
    case accessoryUpdateName
}
```

### Diagnostics
```swift
public struct DiagnosticsEvent {
    public enum Outcome { case success, case failure }
    public let operation: HomeKitOperation
    public let context: DiagnosticsContext
    public let duration: TimeInterval
    public let timestamp: Date
    public let outcome: Outcome
    public let metadata: [String: String]
}

public struct DiagnosticsContext {
    public let accessoryName: String?
    public let serviceType: String?
    public let characteristicType: String?
}

public final class DiagnosticsLogger {
    public static let shared: DiagnosticsLogger
    public var latencyWarningThreshold: TimeInterval { get set }

    public func addObserver(_ observer: @escaping (DiagnosticsEvent) -> Void) -> UUID
    public func removeObserver(_ token: UUID)
    public func record(
        operation: HomeKitOperation,
        context: DiagnosticsContext,
        duration: TimeInterval,
        outcome: DiagnosticsEvent.Outcome,
        metadata: [String: String]
    )
}
```

## Generated Types (US3 - ⏳ Pending)

Generated service classes will follow this pattern:

```swift
@MainActor
public final class LightbulbService: Service {
    public var on: Characteristic<Bool>? { get }
    public var brightness: Characteristic<Int>? { get }

    public override init(underlying: HMService)
}
```

## Concurrency Contract
- ✅ All public APIs are annotated `@MainActor`
- ✅ Async/await replaces all callback-based HomeKit APIs
- ✅ Thread-safe discovery via `HomeKitManager`

## Platform Support
- ✅ Conditional compilation with `#if canImport(HomeKit)`
- ✅ Stub implementations for non-HomeKit platforms
- ✅ Cross-platform builds supported

## Testing
- ✅ 7 tests passing
- ✅ Stub behavior validated on non-HomeKit platforms
- ✅ Integration test structure ready for generated services

## Future Additions (US3)
- SDK-derived catalog generation
- Autogenerated service classes
- SwiftPM plugin for generation pipeline
