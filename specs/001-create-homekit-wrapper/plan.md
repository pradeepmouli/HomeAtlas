# Implementation Plan: Strongly Typed HomeKit Wrapper

**Branch**: `001-create-homekit-wrapper` | **Date**: 2025-11-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-create-homekit-wrapper/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Deliver an SPM-distributed Swift library that exposes compile-time safe HomeKit service, characteristic, accessory, and context (home/room/zone) abstractions. The implementation will pair a canonical HomeKit services catalog extracted from the shipped iOS SDK (ObjC headers + `HomeKit.tbd` under `HomeKit.framework`) — cross-referenced to Developer Apple Context7 (`developer_apple`, HomeKit topic) for documentation — with a SwiftPM command plugin that autogenerates typed wrappers, enforces `@MainActor` interactions, provides deterministic error reporting, adds cache lifecycle controls, and validates latency targets via diagnostics-backed integration tests.

## Technical Context

<!--
  ACTION REQUIRED: Replace the content in this section with the technical details
  for the project. The structure here is presented in advisory capacity to guide
  the iteration process.
-->

**Language/Version**: Swift 6.0 targeting Swift concurrency and macro capabilities.
**Primary Dependencies**: Apple HomeKit framework; Swift Package Manager; Swift Argument Parser + SwiftSyntax for schema-driven generation; Developer Apple Context7 HomeKit metadata as authoritative reference.
**Storage**: YAML/JSON schema files generated from SDK-derived metadata (ObjC headers + `.tbd`) stored in-repo to describe the HomeKit catalog (no runtime storage).
**Testing**: XCTest with concurrency support; CLI snapshot tests for code generation; fallback builds without HomeKit entitlement.
**Target Platform**: iOS 26+, macOS 26+, tvOS 26+, watchOS 26+, plus Linux/macOS build hosts for generation tooling.
**Project Type**: Single Swift package (library target + tooling executables/plugins).
**Performance Goals**: 95% of characteristic read/write helper invocations complete in ≤200 ms on physical accessories (per SC-002) with instrumentation recorded through `DiagnosticsLogger` and asserted in dedicated latency tests.
**Constraints**: All HomeKit-facing APIs run on `@MainActor`; library must compile and provide stub behaviour when HomeKit is unavailable; generation pipeline must stay in sync with Developer Apple updates and SDK exports.
**Scale/Scope**: Full HomeKit services catalog coverage with autogeneration workflow and documentation updates for each service family.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- Type-safe API surface: Autogenerated `ServiceDescriptor` and `CharacteristicValueType` types will expose concrete value wrappers—code review gate will block any `Any` usage in public API.
- MainActor strategy: Public async APIs will be annotated `@MainActor`; generator enforces attribute inclusion; exceptions require explicit documentation referencing Developer Apple guidance.
- Error handling: `HomeKitError` enum extended with accessory/service metadata; logging hooks capture latency diagnostics for slow async reads.
- Coverage evidence: Encode/decode parity tests for each generated service, platform availability stubs compiled via CI matrix (HomeKit available/unavailable), integration example toggling a lighting accessory.
- Documentation updates: README + CHANGELOG entries per service family, pointing to Developer Apple Context7 HomeKit topics and generator workflow instructions.
- External sourcing: All service metadata stored with doc links back to Developer Apple Context7 (`developer_apple`, HomeKit > Services Catalog & Characteristic Metadata).

**Gate Status**: PASS (validated post Phase 1 design; SDK-derived catalog strategy + schema workflow satisfy constitution requirements).

## Project Structure

### Documentation (this feature)

```text
specs/001-create-homekit-wrapper/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   ├── public-api.md
│   └── generator.md
└── tasks.md              # Created by /speckit.tasks (Phase 2)
```

### Source Code (repository root)
<!--
  ACTION REQUIRED: Replace the placeholder tree below with the concrete layout
  for this feature. Delete unused options and expand the chosen structure with
  real paths (e.g., apps/admin, packages/something). The delivered plan must
  not include Option labels.
-->

```text
Sources/
├── SwiftHomeKit/
│   ├── Accessory.swift
│   ├── Characteristic.swift
│   ├── Context/                 # US4 will add HMHome/HMRoom/HMZone wrappers
│   ├── DiagnosticsLogger.swift
│   ├── HomeKitError.swift
│   ├── HomeKitManager.swift
│   ├── Service.swift
│   ├── SwiftHomeKit.swift
│   └── Types.swift
├── HomeKitSchemaGen/
│   ├── CLI/
│   └── Templates/
└── Shared/
  └── Metadata/

Plugins/
└── SwiftHomeKitPlugin/

Tools/
└── HomeKitCatalogExtractor/

Resources/
└── homekit-services.yaml

Tests/
├── SwiftHomeKitTests/
│   ├── Unit/
│   ├── Integration/
│   └── Fallback/
└── GeneratorTests/
```

**Structure Decision**: Single Swift package with `Sources/SwiftHomeKit/` housing runtime code (top-level Swift files today, expanding with `Context/` for US4 cache-aware wrappers), `Sources/HomeKitSchemaGen/` for generation tooling, `Tools/HomeKitCatalogExtractor/` for SDK metadata harvesting utilities, `Plugins/SwiftHomeKitPlugin/` for the SwiftPM command plugin, and `Tests/SwiftHomeKitTests/` covering unit, integration, latency, cache lifecycle, and generated parity tests.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |

## Implementation Strategy

### MVP First (User Story 1)

1. Complete Phases 1–2 (Setup + Foundational) to ensure package, schema models, and generator scaffolding exist.
2. Deliver User Story 1 runtime types and integration test coverage so accessory control compiles and runs deterministically.
3. Publish README guidance referencing Developer Apple Context7 usage examples.

### Incremental Delivery

1. Ship MVP (US1) to unblock integrators.
2. Layer in deterministic error insights (US2) for richer diagnostics, telemetry, and latency measurements.
3. Add the SDK-driven catalog extractor and generation automation (US3) to scale service coverage confidently.
4. Deliver context entity wrappers and cache lifecycle controls (US4) once US1–US3 foundations are in place.

### Parallel Team Strategy

- Developer A: Focus on runtime library (US1) following foundational completion.
- Developer B: Build diagnostics and logging (US2) once error enum stubs exist.
- Developer C: Implement SDK extractor + generator enhancements (US3) leveraging schema scaffolding.
- Shared effort: Documentation and CI polish in Phase 6.

### SDK Catalog Extraction Steps

1. Author a clang-backed utility (`Tools/HomeKitCatalogExtractor/`) that consumes `HMServiceTypes.h`, `HMCharacteristicTypes.h`, and related headers from the active iOS SDK to emit normalized JSON (identifiers, names, availability, developer.apple.com doc slugs).
2. Parse `HomeKit.framework/HomeKit.tbd` alongside the header pass to gather exported `_HMServiceType*` / `_HMCharacteristicType*` symbols; treat mismatches between header + `.tbd` sets as build failures.
3. Feed the merged catalog JSON into the schema pipeline (`Resources/homekit-services.yaml`) so generation remains deterministic and reviewable.
4. Reference Developer Apple Context7 (`developer_apple`, HomeKit topics) when emitting documentation comments, but treat SDK metadata as the authoritative structured source.
