# Data Model: SwiftHomeKit

## Overview

**Current Implementation Status**: US1 runtime library complete; US3 catalog generation pending.

The data model describes both the runtime wrappers (implemented) and the planned SDK-derived catalog that will drive code generation.

## Runtime Types (US1 - ✅ Implemented)

### `Characteristic<Value>`
- **Type**: Open generic class wrapping `HMCharacteristic`
- **Purpose**: Type-safe characteristic access with async/await
- **Properties**:
  - `characteristicType: String` – HomeKit UUID
  - `localizedDescription: String` – User-visible name
  - `supportsRead: Bool`
  - `supportsWrite: Bool`
  - `supportsEventNotification: Bool`
- **Methods**:
  - `func read() async throws -> Value`
  - `func write(_ value: Value) async throws`
  - `func setNotifications(enabled: Bool) async throws`
- **Design**: Open class enables autogenerated subclasses to add service-specific behavior

### `Service`
- **Type**: Open base class wrapping `HMService`
- **Purpose**: Service wrapper for autogenerated subclasses
- **Properties**:
  - `serviceType: String` – HomeKit UUID
  - `name: String?` – User-visible name
  - `isPrimaryService: Bool`
  - `uniqueIdentifier: UUID`
- **Methods**:
  - `func characteristic<Value>(ofType: String) -> Characteristic<Value>?`
  - `func allCharacteristics() -> [Characteristic<Any>]`
- **Design**: Open class allows generated services to add typed characteristic properties

### `Accessory`
- **Type**: Final class wrapping `HMAccessory`
- **Purpose**: Accessory discovery and service access
- **Properties**:
  - `name: String`
  - `uniqueIdentifier: UUID`
  - `isReachable: Bool`
  - `isBlocked: Bool`
- **Methods**:
  - `func service(ofType: String) -> Service?`
  - `func allServices() -> [Service]`
  - `func identify() async throws`
  - `func updateName(_ name: String) async throws`

### `HomeKitManager`
- **Type**: Final class, `@MainActor`, `ObservableObject`
- **Purpose**: Home and accessory discovery
- **Properties**:
  - `@Published var homes: [HMHome]`
  - `@Published var isReady: Bool`
  - `var primaryHome: HMHome?`
- **Methods**:
  - `func waitUntilReady() async`
  - `func allAccessories() -> [Accessory]`
  - `func accessory(named: String) -> Accessory?`
  - `func home(named: String) -> HMHome?`

## Planned Catalog Schema (US3 - ⏳ Pending)

### SDK Extraction Source
- **Input**: iOS SDK header files (`HMServiceTypes.h`, `HMCharacteristicTypes.h`) and `HomeKit.tbd` symbols
- **Approach**: Parse headers for identifiers and metadata, cross-reference with `.tbd` exports
- **Output**: `homekit-services.yaml` catalog

### ServiceCatalogEntry
- **Description**: Extracted service definition from SDK
- **Fields**:
  - `identifier: String` – Service UUID from SDK header
  - `name: String` – Service type name
  - `characteristics: [CharacteristicCatalogEntry]` – Associated characteristics
  - `deprecated: Bool` – Whether marked deprecated in SDK
- **Source**: Parsed from SDK headers, validated against `.tbd` exports

### CharacteristicCatalogEntry
- **Description**: Extracted characteristic definition
- **Fields**:
  - `identifier: String` – Characteristic UUID
  - `name: String` – Characteristic type name
  - `valueType: String` – Swift type mapping (Bool, Int, Double, String, Data)
  - `supportsRead: Bool`
  - `supportsWrite: Bool`
  - `supportsEventNotification: Bool`
  - `deprecated: Bool`
- **Source**: Parsed from SDK headers

## Generation Pipeline (US3 - ⏳ Planned)

1. **SDK Header Parser** parses `.h` files → service/characteristic identifiers
2. **Symbol Extractor** reads `HomeKit.tbd` → exported symbols
3. **Validator** cross-references headers with symbols → validation errors if mismatch
4. **YAML Generator** merges data → `Resources/homekit-services.yaml`
5. **SwiftSyntax Generator** reads YAML → generates service subclasses
6. **Package Plugin** orchestrates pipeline during build

## Generated Code Pattern (US3 - ⏳ Example)

```swift
@MainActor
public final class LightbulbService: Service {
    public var on: Characteristic<Bool>? {
        characteristic(ofType: CharacteristicType.powerState)
    }

    public var brightness: Characteristic<Int>? {
        characteristic(ofType: CharacteristicType.brightness)
    }
}
```
- Tests use the schema to produce encode/decode fixtures for every supported service.
